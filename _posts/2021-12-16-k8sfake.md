---
layout: post
keywords: Fake
description: 如何测试与可k8s交互的服务
title: Go fake for k8s client
categories: [Fake]
tags: [Fake]
group: archive
icon: google
---
{% include sunminghui81/setup %}


### fake k8s client

在服务代码中，与k8s交互我们使用client，这个client中含有对接k8s的kubeconfig配置，并且具有需要跟k8s apiserver交互的方法接口。
在controller-runtime中，有一个client fake；用法见下面示例

```Go
import (
    "context"
    "testing"

    cachev1alpha1 "github.com/example-inc/memcached-operator/pkg/apis/cache/v1alpha1"
    "k8s.io/apimachinery/pkg/runtime"
    "sigs.k8s.io/controller-runtime/pkg/client"
    "sigs.k8s.io/controller-runtime/pkg/client/fake"
)

func TestMemcachedController(t *testing.T) {
    ...
    // A Memcached object with metadata and spec.
    memcached := &cachev1alpha1.Memcached{
        ObjectMeta: metav1.ObjectMeta{
            Name:      "memcached",
            Namespace: "memcached-operator",
            Labels: map[string]string{
                "label-key": "label-value",
            },
        },
    }

    // Objects to track in the fake client.
    objs := []runtime.Object{memcached}

    // Create a fake client to mock API calls.
    cl := fake.NewFakeClient(objs...)

    // List Memcached objects filtering by labels
    opt := client.MatchingLabels(map[string]string{"label-key": "label-value"})
    memcachedList := &cachev1alpha1.MemcachedList{}
    err := cl.List(context.TODO(), memcachedList, opt)
    if err != nil {
        t.Fatalf("list memcached: (%v)", err)
    }
    ...
}
```

###  参考
1. [Unit testing with Operator SDK](https://v0-18-x.sdk.operatorframework.io/docs/golang/unit-testing/)
